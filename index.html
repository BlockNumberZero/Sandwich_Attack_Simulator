<!DOCTYPE html>
<html lang="de">
<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandwich Attack Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
      // Firebase-SDK importieren
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      
      // Firebase-Konfiguration
      const firebaseConfig = {
        apiKey: "AIzaSyDFmAdg24vEhcg-Y8xQ7-rZAmth7w242F0",
        authDomain: "sandwich-attack-simulator.firebaseapp.com",
        projectId: "sandwich-attack-simulator",
        storageBucket: "sandwich-attack-simulator.appspot.com",
        messagingSenderId: "971931585790",
        appId: "1:971931585790:web:9c85bc0a01178eb1769af"
      };
      
      // Firebase initialisieren
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      
      // Globale Variablen für den Zugriff in anderen Skripten
      window.firebaseApp = app;
      window.firebaseAuth = auth;
    </script>
    
    <style>
        :root {
            --background-color: #f3f4f6;
            --card-bg-color: #ffffff;
            --text-color: #1f2937;
            --secondary-text-color: #6b7280;
            --border-color: #e5e7eb;
            --hover-color: #f9fafb;
            --slider-bg: #dbeafe;
            --primary-color: #2563eb;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --table-header-bg: #f9fafb;
            --accent-color: #3b82f6;
        }

        .dark-mode {
            --background-color: #111827;
            --card-bg-color: #1f2937;
            --text-color: #f9fafb;
            --secondary-text-color: #9ca3af;
            --border-color: #374151;
            --hover-color: #374151;
            --slider-bg: #374151;
            --primary-color: #3b82f6;
            --danger-color: #f87171;
            --success-color: #34d399;
            --warning-color: #fbbf24;
            --table-header-bg: #111827;
            --accent-color: #60a5fa;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: var(--card-bg-color);
            color: var(--text-color);
            border-color: var(--border-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .secondary-text {
            color: var(--secondary-text-color);
        }

        input[type=range] {
            background-color: var(--slider-bg);
        }

        input[type=range]::-webkit-slider-thumb {
            background-color: var(--primary-color);
        }

        table th {
            background-color: var(--table-header-bg);
            color: var(--secondary-text-color);
        }

        table td {
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .theme-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background-color: var(--card-bg-color);
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, color 0.3s;
        }

        .theme-toggle:hover {
            background-color: var(--hover-color);
        }

        #attackExplanation {
            background-color: var(--hover-color);
            color: var(--text-color);
        }

        .dark-mode #attackExplanation {
            background-color: #2d3748;
            color: #f9fafb;
        }

        /* Ensuring text colors are correct in dark mode */
        .dark-mode .text-red-500 {
            color: #f87171;
        }

        .dark-mode .text-green-500 {
            color: #34d399;
        }

        .dark-mode .text-yellow-500 {
            color: #fbbf24;
        }

        .dark-mode .text-blue-600 {
            color: #60a5fa;
        }

        .dark-mode .text-blue-800:hover {
            color: #93c5fd;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Anmelde-Seite (wird angezeigt, wenn Benutzer nicht angemeldet ist) -->
    <div id="loginPage" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex flex-col items-center justify-center">
      <div class="max-w-md w-full p-6 bg-white dark:bg-gray-800 shadow-md rounded-lg">
        <h2 class="text-2xl font-bold mb-4 text-center dark:text-white">Sandwich Attack Simulator</h2>
        <p class="mb-6 text-center text-gray-600 dark:text-gray-400">Bitte melden Sie sich an, um auf den Simulator zuzugreifen.</p>
        
        <!-- Tabs für Anmeldemethoden -->
        <div class="mb-4 border-b border-gray-200">
          <ul class="flex flex-wrap -mb-px">
            <li class="mr-2">
              <a id="email-tab" class="inline-block py-2 px-4 text-blue-600 hover:text-blue-800 font-medium border-b-2 border-blue-600 rounded-t-lg dark:text-blue-400 dark:border-blue-400" href="#">E-Mail</a>
            </li>
            <li class="mr-2">
              <a id="google-tab" class="inline-block py-2 px-4 text-gray-500 hover:text-gray-700 font-medium rounded-t-lg dark:text-gray-400 dark:hover:text-gray-300" href="#">Google</a>
            </li>
            <li class="mr-2">
              <a id="microsoft-tab" class="inline-block py-2 px-4 text-gray-500 hover:text-gray-700 font-medium rounded-t-lg dark:text-gray-400 dark:hover:text-gray-300" href="#">Microsoft</a>
            </li>
            <li>
              <a id="register-tab" class="inline-block py-2 px-4 text-gray-500 hover:text-gray-700 font-medium rounded-t-lg dark:text-gray-400 dark:hover:text-gray-300" href="#">Registrieren</a>
            </li>
          </ul>
        </div>
        
        <!-- E-Mail-Login-Formular -->
        <div id="email-login" class="login-form">
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1 dark:text-white" for="email">E-Mail-Adresse</label>
            <input id="email" type="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="ihre@email.de">
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium mb-1 dark:text-white" for="password">Passwort</label>
            <input id="password" type="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="••••••••">
          </div>
          <button id="email-signin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            Anmelden
          </button>
        </div>

        <!-- Google-Login-Button -->
        <div id="google-login" class="login-form hidden">
          <button id="google-signin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center justify-center">
            <span class="mr-2">
              <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512">
                <path fill="white" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"/>
              </svg>
            </span>
            Mit Google anmelden
          </button>
        </div>
        
        <!-- Microsoft-Login-Button -->
        <div id="microsoft-login" class="login-form hidden">
          <button id="microsoft-signin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center justify-center">
            <span class="mr-2">
              <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 23 23">
                <path fill="white" d="M11.4 24H0V12.6h11.4V24zM24 24H12.6V12.6H24V24zM11.4 11.4H0V0h11.4v11.4zM24 11.4H12.6V0H24v11.4z"/>
              </svg>
            </span>
            Mit Microsoft anmelden
          </button>
        </div>
        
        <!-- Registrierungs-Formular -->
        <div id="register-form" class="login-form hidden">
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1 dark:text-white" for="reg-email">E-Mail-Adresse</label>
            <input id="reg-email" type="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="ihre@email.de">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1 dark:text-white" for="reg-password">Passwort</label>
            <input id="reg-password" type="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Mindestens 6 Zeichen">
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium mb-1 dark:text-white" for="reg-password-confirm">Passwort bestätigen</label>
            <input id="reg-password-confirm" type="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Passwort wiederholen">
          </div>
          <button id="register-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
            Registrieren
          </button>
        </div>
        
        <div id="loginError" class="mt-4 text-red-600 text-center hidden"></div>
      </div>
    </div>

    <!-- Haupt-App (wird angezeigt, wenn Benutzer angemeldet ist) -->
    <div id="appContent" class="hidden">
        <!-- Theme Toggle -->
        <div class="theme-toggle" id="themeToggle">
            <i class="fas fa-sun"></i>
        </div>
        
        <!-- Abmelde-Button (oben rechts) -->
        <button id="signout-button" class="fixed top-4 right-20 bg-red-600 hover:bg-red-700 text-white font-medium py-1 px-3 rounded text-sm z-10">
          Abmelden
        </button>

        <!-- Header Section -->
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center">
                <!-- Logo -->
                <a href="https://tlinky.one/Sandwich-Attack-Simulator" target="_blank" 
                class="hover:opacity-75 transition-opacity shrink-0 mr-4">
                    <img src="BlockNumberZeroLogo.gif" alt="BlockNumberZero Logo" 
                        class="h-12 w-auto">
                </a>
                
                <!-- Centered Title Group -->
                <div class="flex-grow text-center">
                    <h1 class="text-3xl font-bold mb-1">Sandwich Attack Simulator (v 0.1)</h1>
                    <h2 class="text-xl secondary-text">Understand how sandwich attacks work in DeFi trading</h2>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Parameters Section -->
                <div class="card p-6 rounded-lg shadow-md col-span-1">
                    <h3 class="text-xl font-semibold mb-4">Parameters</h3>
                    
                    <!-- Price Settings -->
                    <div class="mb-6">
                        <h4 class="font-medium secondary-text mb-2">
                            <i class="fas fa-coins mr-2"></i>Price Settings
                        </h4>
                        <div class="mb-3">
                            <label class="block text-sm mb-1">ETH / USDC ratio</label>
                            <input type="range" id="ethPrice" min="1000" max="20000" step="100" value="2000" 
                                class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs secondary-text">
                                <span>1,000</span>
                                <span id="ethPriceValue">2,000</span>
                                <span>20,000</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gas Cost -->
                    <div class="mb-6">
                        <h4 class="font-medium secondary-text mb-2">
                            <i class="fas fa-gas-pump mr-2"></i>Gas Cost
                        </h4>
                        <div class="mb-3">
                            <label class="block text-sm mb-1">Gas price (Gwei)</label>
                            <input type="range" id="gasPrice" min="1" max="500" step="1" value="20" 
                                class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs secondary-text">
                                <span>1</span>
                                <span id="gasPriceValue">20</span>
                                <span>500</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm mb-1">Gas Cost</label>
                            <div id="gasCost" class="text-sm font-medium">0.0006 ETH</div>
                        </div>
                    </div>
                    
                    <!-- Liquidity Pool -->
                    <div class="mb-6">
                        <h4 class="font-medium secondary-text mb-2">
                            <i class="fas fa-water mr-2"></i>Liquidity Pool
                        </h4>
                        <div class="mb-3">
                            <label class="block text-sm mb-1">Initial ETH Reserve</label>
                            <input type="range" id="ethReserve" min="1000" max="100000" step="10" value="10000" 
                                class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs secondary-text">
                                <span>1k</span>
                                <span id="ethReserveValue">10,000</span>
                                <span>100K</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm mb-1">Initial USDC Reserve</label>
                            <input type="range" id="usdcReserve" min="1000000" max="100000000" step="10000" value="10000000" 
                                class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs secondary-text">
                                <span>1M</span>
                                <span id="usdcReserveValue">1,000,000</span>
                                <span>100M</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm mb-1">Pool Fee (%)</label>
                            <input type="range" id="poolFee" min="0.1" max="1" step="0.1" value="0.3" 
                                class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs secondary-text">
                                <span>0.1%</span>
                                <span id="poolFeeValue">0.3%</span>
                                <span>1%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Victim's Trade -->
                    <div class="mb-6">
                        <h4 class="font-medium secondary-text mb-2">
                            <i class="fas fa-user mr-2"></i>Victim's Trade
                        </h4>
                        <div class="mb-3">
                            <label class="block text-sm mb-1">Trade Amount (ETH)</label>
                            <input type="range" id="tradeAmount" min="0.01" max="100" step="0.01" value="1" 
                                class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs secondary-text">
                                <span>0.01</span>
                                <span id="tradeAmountValue">1</span>
                                <span>100</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm mb-1">Slippage Tolerance (%)</label>
                            <input type="range" id="slippageTolerance" min="0.1" max="10" step="0.1" value="0.5" 
                                class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs secondary-text">
                                <span>0.1%</span>
                                <span id="slippageToleranceValue">0.5%</span>
                                <span>10%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attack Parameters -->
                    <div class="mb-6">
                        <h4 class="font-medium secondary-text mb-2">
                            <i class="fas fa-bolt mr-2"></i>Attack Parameters
                        </h4>
                        <div class="mb-3">
                            <label class="block text-sm mb-1">Front-run amount (ETH)</label>
                            <input type="range" id="frontRunAmount" min="0.001" max="100" step="0.001" value="0.5" 
                                class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs secondary-text">
                                <span>0.001</span>
                                <span id="frontRunAmountValue">0.5</span>
                                <span>100</span>
                            </div>
                        </div>
                    </div>
                    
                    <button id="simulateButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Simulate Attack
                    </button>
                    
                    <div id="debugOutput" class="mt-4 p-3 bg-gray-100 text-xs text-gray-700 rounded overflow-auto max-h-40 hidden">
                        <h4 class="font-bold mb-1">Debug Output:</h4>
                        <pre id="debugLog"></pre>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div class="col-span-1 md:col-span-2">
                    <!-- Price Impact Visualization -->
                    <div class="card p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-semibold mb-4">Price Impact Visualization</h3>
                        <div class="h-64">
                            <canvas id="priceImpactChart"></canvas>
                        </div>
                        <div id="attackStatus" class="mt-4 p-3 text-center font-medium rounded"></div>
                    </div>
                    
                    <!-- Liquidity Depth Chart -->
                    <div class="card p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-semibold mb-4">Liquidity Depth Chart</h3>
                        <div class="h-48">
                            <canvas id="liquidityDepthChart"></canvas>
                        </div>
                        <p class="mt-2 text-sm secondary-text">This chart shows how liquidity is distributed around the current price. The sandwich attack targets the slippage in this zone.</p>
                    </div>
                    
                    <!-- Pool State Updates -->
                    <div class="card p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-semibold mb-4">Pool State Updates</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider">Stage</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium uppercase tracking-wider">ETH Reserve</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium uppercase tracking-wider">USDC Reserve</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium uppercase tracking-wider">Price (USDC/ETH)</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium uppercase tracking-wider">Constant K</th>
                                    </tr>
                                </thead>
                                <tbody id="poolStateTableBody" class="divide-y divide-gray-200">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Attack Summary -->
                    <div class="card p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-semibold mb-4">Attack Summary</h3>
                        
                        <!-- Victim Impact -->
                        <div class="mb-6">
                            <h4 class="font-medium secondary-text mb-2">Victim Impact</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm secondary-text">Expected Output:</p>
                                    <p id="expectedOutput" class="font-medium">-</p>
                                </div>
                                <div>
                                    <p class="text-sm secondary-text">Actual Output:</p>
                                    <p id="actualOutput" class="font-medium">-</p>
                                </div>
                                <div>
                                    <p class="text-sm secondary-text">Price Impact:</p>
                                    <p id="priceImpact" class="font-medium">-</p>
                                </div>
                                <div>
                                    <p class="text-sm secondary-text">Slippage Tolerance:</p>
                                    <p id="slippageDisplay" class="font-medium">-</p>
                                </div>
                                <div>
                                    <p class="text-sm secondary-text">Transaction Status:</p>
                                    <p id="transactionStatus" class="font-medium">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Attacker's Profit -->
                        <div>
                            <h4 class="font-medium secondary-text mb-2">Attacker's Profit</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm secondary-text">Front-run Cost:</p>
                                    <p id="frontRunCost" class="font-medium">-</p>
                                </div>
                                <div>
                                    <p class="text-sm secondary-text">Back-run Return:</p>
                                    <p id="backRunReturn" class="font-medium">-</p>
                                </div>
                                <div>
                                    <p class="text-sm secondary-text">Gas Cost (Total):</p>
                                    <p id="totalGasCost" class="font-medium">-</p>
                                </div>
                                <div>
                                    <p class="text-sm secondary-text">Net Profit:</p>
                                    <p id="netProfit" class="font-medium">-</p>
                                </div>
                                <div>
                                    <p class="text-sm secondary-text">ROI:</p>
                                    <p id="roi" class="font-medium">-</p>
                                </div>
                                <div>
                                    <p class="text-sm secondary-text">Profitable After Gas:</p>
                                    <p id="isProfitable" class="font-medium">-</p>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button id="toggleExplanation" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                                    <span>Why is this attack profitable or not?</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div id="attackExplanation" class="mt-2 p-3 rounded text-sm hidden">
                                    Explanation will appear here after simulation.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Transaction Breakdown -->
                    <div class="card p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-semibold mb-4">Detailed Transaction Breakdown</h3>
                        
                        <!-- Front-run Transaction -->
                        <div class="mb-4">
                            <button class="toggle-details flex justify-between items-center w-full text-left font-medium py-2 border-b">
                                <span>Front-run Transaction</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div class="details-content hidden mt-2">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm secondary-text">ETH Input:</p>
                                        <p id="frontRunEthInput" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">Fee:</p>
                                        <p id="frontRunFee" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">ETH After Fee:</p>
                                        <p id="frontRunEthAfterFee" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">USDC Output:</p>
                                        <p id="frontRunUsdcOutput" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">Calculation:</p>
                                        <p id="frontRunCalculation" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">New Pool Price:</p>
                                        <p id="frontRunNewPrice" class="font-medium">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Victim's Transaction -->
                        <div class="mb-4">
                            <button class="toggle-details flex justify-between items-center w-full text-left font-medium py-2 border-b">
                                <span>Victim's Transaction</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div class="details-content hidden mt-2">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm secondary-text">ETH Input:</p>
                                        <p id="victimEthInput" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">Fee:</p>
                                        <p id="victimFee" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">ETH After Fee:</p>
                                        <p id="victimEthAfterFee" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">Expected Output (Initial Pool):</p>
                                        <p id="victimExpectedOutput" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">Actual Output (After Front-run):</p>
                                        <p id="victimActualOutput" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">Difference:</p>
                                        <p id="victimDifference" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">Slippage Tolerance:</p>
                                        <p id="victimSlippageTolerance" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">Transaction Status:</p>
                                        <p id="victimTransactionStatus" class="font-medium">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Back-run Transaction -->
                        <div class="mb-4">
                            <button class="toggle-details flex justify-between items-center w-full text-left font-medium py-2 border-b">
                                <span>Back-run Transaction</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div class="details-content hidden mt-2">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm secondary-text">USDC Input:</p>
                                        <p id="backRunUsdcInput" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">Fee:</p>
                                        <p id="backRunFee" class="font-medium">-</p>
                                    </div>
                                                                        <div>
                                        <p class="text-sm secondary-text">USDC After Fee:</p>
                                        <p id="backRunUsdcAfterFee" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">ETH Output:</p>
                                        <p id="backRunEthOutput" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">Calculation:</p>
                                        <p id="backRunCalculation" class="font-medium">-</p>
                                    </div>
                                    <div>
                                        <p class="text-sm secondary-text">Final Pool Price:</p>
                                        <p id="backRunFinalPrice" class="font-medium">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mathematical Breakdown -->
                        <div>
                            <button class="toggle-details flex justify-between items-center w-full text-left font-medium py-2 border-b">
                                <span>Mathematical Breakdown</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div class="details-content hidden mt-2">
                                <div class="mb-3">
                                    <h5 class="font-medium">Constant Product Formula</h5>
                                    <p class="text-sm">The core formula that AMMs use: x * y = k, where x and y are token reserves and k is a constant. For any trade, the product of reserves must remain constant (except for fee accumulation).</p>
                                </div>
                                <div class="mb-3">
                                    <h5 class="font-medium">Front-run Calculation</h5>
                                    <p id="mathFrontRun" class="text-sm">tokenOutput = y - k / (x + ethInput * (1 - fee))</p>
                                </div>
                                <div class="mb-3">
                                    <h5 class="font-medium">Price Impact Calculation</h5>
                                    <p id="mathPriceImpact" class="text-sm">priceImpact = (expectedOutput - actualOutput) / expectedOutput * 100</p>
                                </div>
                                <div>
                                    <h5 class="font-medium">Profit Calculation</h5>
                                    <p id="mathProfit" class="text-sm">profit = backRunEthOutput - frontRunAmount - gasCost</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Authentifizierungs-Logik -->
    <script type="module">
      import { 
        signInWithPopup, 
        GoogleAuthProvider, 
        OAuthProvider,
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword,
        onAuthStateChanged 
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
      
      // Liste der autorisierten E-Mail-Adressen
      const authorizedEmails = [
        "rey.creacionweb@gmail.com",
        "rey.miller.chancahuana.almora@gmail.com",
        "Kgotlellovic@gmail.com",
        "rozjebanej90@gmail.com",
        "joyceyyc@gmail.com",
        "wiro.pribadi@gmail.com",
        "bushel-elevens-9k@icloud.com",
        "david@hackernoon.com",
        "rey.miller@hotmail.com" // Microsoft-Account hinzugefügt
      ];
      
      // DOM-Elemente
      const loginPage = document.getElementById('loginPage');
      const appContent = document.getElementById('appContent');
      const loginError = document.getElementById('loginError');
      const signInButton = document.getElementById('google-signin');
      const microsoftSignInButton = document.getElementById('microsoft-signin');
      const emailSignInButton = document.getElementById('email-signin');
      const registerButton = document.getElementById('register-button');
      const signOutButton = document.getElementById('signout-button');
      
      // Tab-Elemente
      const emailTab = document.getElementById('email-tab');
      const googleTab = document.getElementById('google-tab');
      const microsoftTab = document.getElementById('microsoft-tab');
      const registerTab = document.getElementById('register-tab');
      const emailLogin = document.getElementById('email-login');
      const googleLogin = document.getElementById('google-login');
      const microsoftLogin = document.getElementById('microsoft-login');
      const registerForm = document.getElementById('register-form');
      
      // Tab-Wechsel-Funktionen
      emailTab.addEventListener('click', (e) => {
        e.preventDefault();
        setActiveTab(emailTab, emailLogin);
      });
      
      googleTab.addEventListener('click', (e) => {
        e.preventDefault();
        setActiveTab(googleTab, googleLogin);
      });
      
      microsoftTab.addEventListener('click', (e) => {
        e.preventDefault();
        setActiveTab(microsoftTab, microsoftLogin);
      });
      
      registerTab.addEventListener('click', (e) => {
        e.preventDefault();
        setActiveTab(registerTab, registerForm);
      });
      
      function setActiveTab(tab, content) {
        // Alle Tabs zurücksetzen
        [emailTab, googleTab, microsoftTab, registerTab].forEach(t => {
          t.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'dark:text-blue-400', 'dark:border-blue-400');
          t.classList.add('text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400', 'dark:hover:text-gray-300');
        });
        
        // Aktiven Tab setzen
        tab.classList.remove('text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400', 'dark:hover:text-gray-300');
        tab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'dark:text-blue-400', 'dark:border-blue-400');
        
        // Alle Inhalte ausblenden
        [emailLogin, googleLogin, microsoftLogin, registerForm].forEach(c => {
          c.classList.add('hidden');
        });
        
        // Gewählten Inhalt anzeigen
        content.classList.remove('hidden');
        
        // Fehlermeldung zurücksetzen
        loginError.classList.add('hidden');
      }
      
      // Prüfen, ob eine E-Mail autorisiert ist (nur spezifische E-Mail-Adressen)
      function isAuthorizedEmail(email) {
        if (!email) return false;
        
        // Auf Kleinbuchstaben normalisieren für den Vergleich
        return authorizedEmails.map(e => e.toLowerCase()).includes(email.toLowerCase());
      }
      
      // Authentifizierungsstatus überwachen
      onAuthStateChanged(window.firebaseAuth, (user) => {
        if (user) {
          console.log('Angemeldet als:', user.email);
          
          // Prüfen, ob die E-Mail-Adresse autorisiert ist
          if (isAuthorizedEmail(user.email)) {
            // Autorisierter Benutzer - App anzeigen
            loginPage.classList.add('hidden');
            appContent.classList.remove('hidden');
          } else {
            // Nicht autorisierter Benutzer - Fehlermeldung anzeigen
            loginError.textContent = "Sie sind nicht berechtigt, auf diese Anwendung zuzugreifen.";
            loginError.classList.remove('hidden');
            
            // Benutzer abmelden
            window.firebaseAuth.signOut();
          }
        } else {
          // Benutzer ist nicht angemeldet - Login-Seite anzeigen
          loginPage.classList.remove('hidden');
          appContent.classList.add('hidden');
        }
      });
      
      // Event-Listener für den Google-Anmelde-Button
      signInButton.addEventListener('click', () => {
        loginError.classList.add('hidden');
        const provider = new GoogleAuthProvider();
        signInWithPopup(window.firebaseAuth, provider)
          .catch((error) => {
            console.error('Anmeldefehler:', error);
            loginError.textContent = "Google-Anmeldefehler: " + error.message;
            loginError.classList.remove('hidden');
          });
      });
      
      // Event-Listener für den Microsoft-Anmelde-Button
      microsoftSignInButton.addEventListener('click', () => {
        loginError.classList.add('hidden');
        const provider = new OAuthProvider('microsoft.com');
        signInWithPopup(window.firebaseAuth, provider)
          .catch((error) => {
            console.error('Microsoft-Anmeldefehler:', error);
            loginError.textContent = "Microsoft-Anmeldefehler: " + error.message;
            loginError.classList.remove('hidden');
          });
      });
      
      // Event-Listener für den E-Mail-Anmelde-Button
      emailSignInButton.addEventListener('click', () => {
        loginError.classList.add('hidden');
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
          loginError.textContent = "Bitte geben Sie E-Mail und Passwort ein";
          loginError.classList.remove('hidden');
          return;
        }
        
        signInWithEmailAndPassword(window.firebaseAuth, email, password)
          .catch((error) => {
            console.error('E-Mail-Anmeldefehler:', error);
            let errorMessage = error.message;
            
            // Benutzerfreundlichere Fehlermeldungen
            if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
              errorMessage = "Ungültige E-Mail-Adresse oder falsches Passwort.";
            } else if (error.code === 'auth/user-not-found') {
              errorMessage = "Kein Benutzerkonto mit dieser E-Mail-Adresse gefunden.";
            }
            
            loginError.textContent = errorMessage;
            loginError.classList.remove('hidden');
          });
      });
      
      // Event-Listener für den Registrierungs-Button
      registerButton.addEventListener('click', () => {
        loginError.classList.add('hidden');
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const passwordConfirm = document.getElementById('reg-password-confirm').value;
        
        if (!email || !password || !passwordConfirm) {
          loginError.textContent = "Bitte füllen Sie alle Felder aus";
          loginError.classList.remove('hidden');
          return;
        }
        
        if (password !== passwordConfirm) {
          loginError.textContent = "Die Passwörter stimmen nicht überein";
          loginError.classList.remove('hidden');
          return;
        }
        
        if (password.length < 6) {
          loginError.textContent = "Das Passwort muss mindestens 6 Zeichen lang sein";
          loginError.classList.remove('hidden');
          return;
        }
        
        // Vor der Registrierung prüfen, ob die E-Mail autorisiert ist
        if (!isAuthorizedEmail(email)) {
          loginError.textContent = "Diese E-Mail-Adresse ist nicht für die Registrierung zugelassen";
          loginError.classList.remove('hidden');
          return;
        }
        
        createUserWithEmailAndPassword(window.firebaseAuth, email, password)
          .then(() => {
            // Registrierung erfolgreich
            console.log('Benutzer erfolgreich registriert');
            // Zurück zum Login-Tab wechseln
            setActiveTab(emailTab, emailLogin);
            document.getElementById('email').value = email;
          })
          .catch((error) => {
            console.error('Registrierungsfehler:', error);
            let errorMessage = error.message;
            
            // Benutzerfreundlichere Fehlermeldungen
            if (error.code === 'auth/email-already-in-use') {
              errorMessage = "Ein Benutzerkonto mit dieser E-Mail-Adresse existiert bereits.";
            } else if (error.code === 'auth/invalid-email') {
              errorMessage = "Die E-Mail-Adresse ist ungültig.";
            } else if (error.code === 'auth/weak-password') {
              errorMessage = "Das Passwort ist zu schwach. Bitte wählen Sie ein stärkeres Passwort.";
            }
            
            loginError.textContent = errorMessage;
            loginError.classList.remove('hidden');
          });
      });
      
      // Event-Listener für den Abmelde-Button
      signOutButton.addEventListener('click', () => {
        window.firebaseAuth.signOut()
          .then(() => {
            console.log('Erfolgreich abgemeldet');
          })
          .catch((error) => {
            console.error('Abmeldefehler:', error);
          });
      });
    </script>
    
    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        const icon = themeToggle.querySelector('i');
        
        // Check for saved theme preference or use preferred color scheme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            body.classList.add('dark-mode');
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
        }
        
        // Toggle theme
        themeToggle.addEventListener('click', function() {
            body.classList.toggle('dark-mode');
            
            if (body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('theme', 'dark');
                
                // Update chart themes if they exist
                if (priceImpactChart) {
                    priceImpactChart.options.plugins.legend.labels.color = '#f9fafb';
                    priceImpactChart.options.scales.x.ticks.color = '#9ca3af';
                    priceImpactChart.options.scales.y.ticks.color = '#9ca3af';
                    priceImpactChart.options.scales.y.title.color = '#9ca3af';
                    priceImpactChart.update();
                }
                
                if (liquidityDepthChart) {
                    liquidityDepthChart.options.plugins.legend.labels.color = '#f9fafb';
                    liquidityDepthChart.options.scales.x.ticks.color = '#9ca3af';
                    liquidityDepthChart.options.scales.y.ticks.color = '#9ca3af';
                    liquidityDepthChart.options.scales.y.title.color = '#9ca3af';
                    liquidityDepthChart.update();
                }
            } else {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('theme', 'light');
                
                // Update chart themes if they exist
                if (priceImpactChart) {
                    priceImpactChart.options.plugins.legend.labels.color = '#1f2937';
                    priceImpactChart.options.scales.x.ticks.color = '#6b7280';
                    priceImpactChart.options.scales.y.ticks.color = '#6b7280';
                    priceImpactChart.options.scales.y.title.color = '#6b7280';
                    priceImpactChart.update();
                }
                
                if (liquidityDepthChart) {
                    liquidityDepthChart.options.plugins.legend.labels.color = '#1f2937';
                    liquidityDepthChart.options.scales.x.ticks.color = '#6b7280';
                    liquidityDepthChart.options.scales.y.ticks.color = '#6b7280';
                    liquidityDepthChart.options.scales.y.title.color = '#6b7280';
                    liquidityDepthChart.update();
                }
            }
        });

        // Enable debug mode - set to true to show debug output
        const DEBUG = true;
        
        // Debug logger function
        function log(message) {
            if (DEBUG) {
                console.log(message);
                
                const debugOutput = document.getElementById('debugOutput');
                const debugLog = document.getElementById('debugLog');
                
                debugOutput.classList.remove('hidden');
                debugLog.textContent += message + '\n';
                
                // Auto-scroll to bottom
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }

        // Corrected number formatting function
        function formatNumber(num, decimals = 4) {
            if (num === undefined || num === null || isNaN(num)) return '-';
            
            // For very small numbers near zero
            if (Math.abs(num) < 0.0001 && num !== 0) {
                return num.toExponential(4);
            }
            
            // Handle different formats based on size
            let formatted;
            if (Math.abs(num) >= 1000000) {
                formatted = (num / 1000000).toFixed(2) + 'M';
            } else if (Math.abs(num) >= 1000) {
                formatted = (num / 1000).toFixed(2) + 'K';
            } else {
                formatted = num.toFixed(decimals);
            }
            
            // Split into integer and decimal parts
            const parts = formatted.split('.');
            // Add commas only to the integer part
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            // Recombine parts
            return parts.join('.');
        }

        // Update input value displays
        function updateValueDisplays() {
            document.getElementById('ethPriceValue').textContent = formatNumber(parseFloat(document.getElementById('ethPrice').value), 0);
            document.getElementById('gasPriceValue').textContent = document.getElementById('gasPrice').value;
            document.getElementById('ethReserveValue').textContent = formatNumber(parseFloat(document.getElementById('ethReserve').value), 0);
            document.getElementById('usdcReserveValue').textContent = formatNumber(parseFloat(document.getElementById('usdcReserve').value), 0);
            document.getElementById('poolFeeValue').textContent = document.getElementById('poolFee').value + '%';
            document.getElementById('tradeAmountValue').textContent = document.getElementById('tradeAmount').value;
            document.getElementById('slippageToleranceValue').textContent = document.getElementById('slippageTolerance').value + '%';
            document.getElementById('frontRunAmountValue').textContent = document.getElementById('frontRunAmount').value;
            
            // Update gas cost
            const gasPrice = parseFloat(document.getElementById('gasPrice').value);
            const gasUnits = 150000; // Approximate gas units for a swap
            const gasCostETH = (gasPrice * gasUnits) / 1e9; // Convert from Gwei to ETH
            document.getElementById('gasCost').textContent = `${formatNumber(gasCostETH, 6)} ETH`;
            
            log('Updated value displays');
        }

        // Get simulation parameters from the UI
        function getParameters() {
            return {
                ethPrice: parseFloat(document.getElementById('ethPrice').value),
                gasPrice: parseFloat(document.getElementById('gasPrice').value),
                ethReserve: parseFloat(document.getElementById('ethReserve').value),
                usdcReserve: parseFloat(document.getElementById('usdcReserve').value),
                poolFee: parseFloat(document.getElementById('poolFee').value) / 100, // Convert percentage to decimal
                tradeAmount: parseFloat(document.getElementById('tradeAmount').value),
                slippageTolerance: parseFloat(document.getElementById('slippageTolerance').value) / 100, // Convert percentage to decimal
                frontRunAmount: parseFloat(document.getElementById('frontRunAmount').value)
            };
        }

        // Calculate output amount for a given input with proper fee handling
        function getOutputAmountWithFee(inputAmount, inputReserve, outputReserve, fee) {
            log(`Calculating output for: input=${inputAmount}, inputReserve=${inputReserve}, outputReserve=${outputReserve}, fee=${fee}`);
            
            // Calculate fee amount
            const feeAmount = inputAmount * fee;
            log(`Fee amount: ${feeAmount}`);
            
            // Input amount after fee deduction (for output calculation)
            const inputAmountAfterFee = inputAmount - feeAmount;
            log(`Input after fee: ${inputAmountAfterFee}`);
            
            // Calculate constant product before trade
            const k = inputReserve * outputReserve;
            log(`Initial k: ${k}`);
            
            // Calculate new input reserve (full input amount is added)
            const newInputReserve = inputReserve + inputAmount;
            log(`New input reserve: ${newInputReserve}`);
            
            // Calculate new output reserve based on the constant product formula
            // Using input amount minus fee for the calculation
            const newOutputReserve = k / (inputReserve + inputAmountAfterFee);
            log(`New output reserve: ${newOutputReserve}`);
            
            // Calculate output amount
            const outputAmount = outputReserve - newOutputReserve;
            log(`Output amount: ${outputAmount}`);
            
            // Calculate new constant product (increases due to fee)
            const newK = newInputReserve * newOutputReserve;
            log(`New k: ${newK} (should be greater than initial k due to fees)`);
            
            return {
                outputAmount: outputAmount,
                newInputReserve: newInputReserve,
                newOutputReserve: newOutputReserve,
                oldK: k,
                newK: newK,
                feeAmount: feeAmount
            };
        }

        // Simulate front-run transaction
        function simulateFrontRun(ethReserve, usdcReserve, frontRunAmount, poolFee) {
            log('Simulating front-run transaction');
            log(`Initial state: ETH=${ethReserve}, USDC=${usdcReserve}, amount=${frontRunAmount}, fee=${poolFee}`);
            
            // Calculate ETH to USDC swap
            const result = getOutputAmountWithFee(
                frontRunAmount,  // ETH input
                ethReserve,      // ETH reserve
                usdcReserve,     // USDC reserve
                poolFee          // Pool fee
            );
            
            log(`Front-run result: ETH input=${frontRunAmount}, USDC output=${result.outputAmount}`);
            log(`New reserves: ETH=${result.newInputReserve}, USDC=${result.newOutputReserve}`);
            
            return {
                ethInput: frontRunAmount,
                fee: frontRunAmount * poolFee,
                ethAfterFee: frontRunAmount - (frontRunAmount * poolFee),
                usdcOutput: result.outputAmount,
                newEthReserve: result.newInputReserve,
                newUsdcReserve: result.newOutputReserve,
                oldK: result.oldK,
                newK: result.newK
            };
        }

        // Simulate victim's transaction
        function simulateVictimTrade(ethReserve, usdcReserve, tradeAmount, poolFee, slippageTolerance, originalEthReserve, originalUsdcReserve) {
            log('Simulating victim transaction');
            log(`Initial state: ETH=${ethReserve}, USDC=${usdcReserve}, amount=${tradeAmount}, fee=${poolFee}`);
            log(`Original state (for expected output): ETH=${originalEthReserve}, USDC=${originalUsdcReserve}`);
            
            // Calculate expected output if there was no front-running
            const expectedResult = getOutputAmountWithFee(
                tradeAmount,
                originalEthReserve,
                originalUsdcReserve,
                poolFee
            );
            
            log(`Expected output (no front-run): ${expectedResult.outputAmount} USDC`);
            
            // Calculate actual output after front-running
            const actualResult = getOutputAmountWithFee(
                tradeAmount,
                ethReserve,
                usdcReserve,
                poolFee
            );
            
            log(`Actual output (after front-run): ${actualResult.outputAmount} USDC`);
            
            // Calculate price impact
            const priceImpact = 
                (expectedResult.outputAmount - actualResult.outputAmount) / 
                expectedResult.outputAmount * 100;
            
            log(`Price impact: ${priceImpact.toFixed(6)}%`);
            
            // Determine if transaction succeeds based on slippage tolerance
            const transactionSucceeds = priceImpact <= (slippageTolerance * 100);
            log(`Transaction succeeds: ${transactionSucceeds} (impact: ${priceImpact.toFixed(6)}%, tolerance: ${(slippageTolerance * 100).toFixed(2)}%)`);
            
            return {
                ethInput: tradeAmount,
                fee: tradeAmount * poolFee,
                ethAfterFee: tradeAmount - (tradeAmount * poolFee),
                expectedOutput: expectedResult.outputAmount,
                actualOutput: actualResult.outputAmount,
                difference: expectedResult.outputAmount - actualResult.outputAmount,
                priceImpact: priceImpact,
                transactionSucceeds: transactionSucceeds,
                newEthReserve: transactionSucceeds ? actualResult.newInputReserve : ethReserve,
                newUsdcReserve: transactionSucceeds ? actualResult.newOutputReserve : usdcReserve,
                oldK: actualResult.oldK,
                newK: transactionSucceeds ? actualResult.newK : actualResult.oldK
            };
        }

        // Simulate back-run transaction
        function simulateBackRun(ethReserve, usdcReserve, usdcInput, poolFee) {
            log('Simulating back-run transaction');
            log(`Initial state: ETH=${ethReserve}, USDC=${usdcReserve}, USDC input=${usdcInput}, fee=${poolFee}`);
            
            // Calculate USDC to ETH swap
            const result = getOutputAmountWithFee(
                usdcInput,      // USDC input
                usdcReserve,    // USDC reserve
                ethReserve,     // ETH reserve
                poolFee         // Pool fee
            );
            
            log(`Back-run result: USDC input=${usdcInput}, ETH output=${result.outputAmount}`);
            log(`New reserves: USDC=${result.newInputReserve}, ETH=${result.newOutputReserve}`);
            
            return {
                usdcInput: usdcInput,
                fee: usdcInput * poolFee,
                usdcAfterFee: usdcInput - (usdcInput * poolFee),
                ethOutput: result.outputAmount,
                newUsdcReserve: result.newInputReserve,
                newEthReserve: result.newOutputReserve,
                oldK: result.oldK,
                newK: result.newK
            };
        }

        // Calculate profit
        function calculateProfit(frontRunCost, backRunReturn, gasPrice) {
            log('Calculating profit');
            log(`Front-run cost: ${frontRunCost}, back-run return: ${backRunReturn}, gas price: ${gasPrice}`);
            
            // Standard gas units for a swap
            const gasUsedFrontRun = 150000;
            const gasUsedBackRun = 150000;
            
            // Convert gas price from Gwei to ETH
            const frontRunGasCost = (gasPrice * gasUsedFrontRun) / 1e9;
            const backRunGasCost = (gasPrice * gasUsedBackRun) / 1e9;
            const totalGasCost = frontRunGasCost + backRunGasCost;
            
            log(`Gas costs: front-run=${frontRunGasCost}, back-run=${backRunGasCost}, total=${totalGasCost}`);
            
            // Calculate net profit
            const netProfit = backRunReturn - frontRunCost - totalGasCost;
            log(`Net profit: ${netProfit}`);
            
            // Calculate ROI
            let roi = 0;
            if (frontRunCost > 0) {
                roi = (netProfit / frontRunCost) * 100;
            }
            log(`ROI: ${roi}%`);
            
            return {
                frontRunGasCost: frontRunGasCost,
                backRunGasCost: backRunGasCost,
                totalGasCost: totalGasCost,
                netProfit: netProfit,
                roi: roi,
                isProfitable: netProfit > 0
            };
        }

        // Initialize charts
        let priceImpactChart = null;
        let liquidityDepthChart = null;

        function initializeCharts() {
            // Set text colors based on theme
            const isDarkMode = document.body.classList.contains('dark-mode');
            const textColor = isDarkMode ? '#9ca3af' : '#6b7280';
            const labelColor = isDarkMode ? '#f9fafb' : '#1f2937';
            
            // Price Impact Chart
            const priceImpactCtx = document.getElementById('priceImpactChart').getContext('2d');
            priceImpactChart = new Chart(priceImpactCtx, {
                type: 'line',
                data: {
                    labels: ['Initial', 'Front-run', 'Victim Trade', 'Back-run'],
                    datasets: [
                        {
                            label: 'Natural Price',
                            data: [0, 0, 0, 0],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Sandwich Attack Price',
                            data: [0, 0, 0, 0],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: labelColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price (USDC/ETH)',
                                color: textColor
                            },
                            ticks: {
                                color: textColor
                            }
                        }
                    }
                }
            });
            
            // Liquidity Depth Chart
            const liquidityDepthCtx = document.getElementById('liquidityDepthChart').getContext('2d');
            liquidityDepthChart = new Chart(liquidityDepthCtx, {
                type: 'bar',
                data: {
                    labels: ['Buy Side', 'Current Price', 'Sell Side'],
                    datasets: [{
                        label: 'Liquidity',
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(255, 99, 132, 0.6)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: labelColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Liquidity Depth',
                                color: textColor
                            },
                            ticks: {
                                color: textColor
                            }
                        }
                    }
                }
            });
            
            log('Charts initialized');
        }

        // Update price impact chart
        function updatePriceImpactChart(stages) {
            log('Updating price impact chart');
            
            // Calculate data points for natural price without attack
            const naturalPricePoints = [];
            naturalPricePoints.push(stages[0].usdcReserve / stages[0].ethReserve);
            
            // Calculate data for victim trade without front-run
            const victimTradeResult = getOutputAmountWithFee(
                getParameters().tradeAmount,
                stages[0].ethReserve,
                stages[0].usdcReserve,
                getParameters().poolFee
            );
            
            const naturalPriceAfterVictim = victimTradeResult.newOutputReserve / victimTradeResult.newInputReserve;
            naturalPricePoints.push(naturalPricePoints[0]); // Hold steady to front-run point
            naturalPricePoints.push(naturalPriceAfterVictim); // Drop at victim trade
            naturalPricePoints.push(naturalPriceAfterVictim); // Stay at final price
            
            log(`Natural price points: ${JSON.stringify(naturalPricePoints)}`);
            
            // Calculate data points for attack price
            const attackPricePoints = [];
            
            for (let i = 0; i < stages.length; i++) {
                attackPricePoints.push(stages[i].usdcReserve / stages[i].ethReserve);
            }
            
            log(`Attack price points: ${JSON.stringify(attackPricePoints)}`);
            
            // Update chart data
            priceImpactChart.data.datasets[0].data = naturalPricePoints;
            priceImpactChart.data.datasets[1].data = attackPricePoints;
            priceImpactChart.update();
            
            log('Price impact chart updated');
        }

        // Update liquidity depth chart
        function updateLiquidityDepthChart(stages, victimResult) {
            log('Updating liquidity depth chart');
            
            const initialPrice = stages[0].usdcReserve / stages[0].ethReserve;
            const priceAfterFrontRun = stages[1].usdcReserve / stages[1].ethReserve;
            
            // Calculate liquidity on buy and sell sides
            const buySideLiquidity = stages[0].ethReserve * 0.5; // Simplified representation
            const sellSideLiquidity = stages[0].usdcReserve / initialPrice * 0.5; // Convert to ETH equivalent
            
            // Calculate sandwich zone based on price impact
            const sandwichZone = victimResult.priceImpact * sellSideLiquidity / 100;
            
            // Update chart data
            liquidityDepthChart.data.datasets[0].data = [buySideLiquidity, sandwichZone, sellSideLiquidity];
            liquidityDepthChart.update();
            
            log('Liquidity depth chart updated');
        }

        // Update pool state table
        function updatePoolStateTable(stages) {
            log('Updating pool state table');
            
            const tableBody = document.getElementById('poolStateTableBody');
            tableBody.innerHTML = '';
            
            stages.forEach(stage => {
                const row = document.createElement('tr');
                
                const stageCell = document.createElement('td');
                stageCell.textContent = stage.name;
                stageCell.className = 'px-4 py-2';
                row.appendChild(stageCell);
                
                const ethReserveCell = document.createElement('td');
                ethReserveCell.textContent = formatNumber(stage.ethReserve);
                ethReserveCell.className = 'px-4 py-2 text-right';
                row.appendChild(ethReserveCell);
                
                const usdcReserveCell = document.createElement('td');
                usdcReserveCell.textContent = formatNumber(stage.usdcReserve);
                usdcReserveCell.className = 'px-4 py-2 text-right';
                row.appendChild(usdcReserveCell);
                
                const priceCell = document.createElement('td');
                priceCell.textContent = formatNumber(stage.usdcReserve / stage.ethReserve);
                priceCell.className = 'px-4 py-2 text-right';
                row.appendChild(priceCell);
                
                const kCell = document.createElement('td');
                kCell.textContent = formatNumber(stage.k);
                kCell.className = 'px-4 py-2 text-right';
                row.appendChild(kCell);
                
                tableBody.appendChild(row);
            });
            
            log('Pool state table updated');
        }

        // Update attack status indicator
        function updateAttackStatus(victimResult, profitResult) {
            log('Updating attack status');
            
            const attackStatusElement = document.getElementById('attackStatus');
            
            if (!victimResult.transactionSucceeds) {
                attackStatusElement.textContent = 'Transaction would fail due to high price impact!';
                attackStatusElement.className = 'mt-4 p-3 text-center font-medium rounded bg-yellow-100 text-yellow-800';
            } else if (profitResult.isProfitable) {
                attackStatusElement.textContent = 'This transaction has a high risk of being sandwich attacked!';
                attackStatusElement.className = 'mt-4 p-3 text-center font-medium rounded bg-red-100 text-red-800';
            } else {
                attackStatusElement.textContent = 'This transaction has a low risk of being sandwich attacked.';
                attackStatusElement.className = 'mt-4 p-3 text-center font-medium rounded bg-green-100 text-green-800';
            }
            
            log(`Attack status set to: ${attackStatusElement.textContent}`);
        }

        // Update profit explanation
        function updateExplanation(victimResult, profitResult) {
            log('Updating profit explanation');
            
            const explanationContainer = document.getElementById('attackExplanation');
            
            if (victimResult.transactionSucceeds) {
                if (profitResult.isProfitable) {
                    explanationContainer.innerHTML = `
                        <div class="text-red-500 font-bold">This attack is profitable for the attacker.</div>
                        <p>The attacker profits ${formatNumber(profitResult.netProfit)} ETH because:</p>
                        <ul class="list-disc pl-5">
                            <li>The front-run transaction increased the ETH reserves, causing price impact</li>
                            <li>The victim's transaction succeeded but received ${formatNumber(victimResult.difference)} fewer USDC than expected</li>
                            <li>The back-run transaction exploited the price movement to profit</li>
                            <li>The total gas cost of ${formatNumber(profitResult.totalGasCost)} ETH was less than the profit gained</li>
                        </ul>
                        <p>This represents a ${formatNumber(profitResult.roi)}% return on investment.</p>
                    `;
                } else {
                    explanationContainer.innerHTML = `
                        <div class="text-green-500 font-bold">This attack is not profitable for the attacker.</div>
                        <p>The attacker loses ${formatNumber(Math.abs(profitResult.netProfit))} ETH because:</p>
                        <ul class="list-disc pl-5">
                            <li>The price impact created by front-running (${formatNumber(victimResult.priceImpact)}%) was too small</li>
                            <li>The back-run transaction did not return enough ETH to cover the initial cost</li>
                            <li>The gas costs of ${formatNumber(profitResult.totalGasCost)} ETH eliminated any potential profit</li>
                        </ul>
                        <p>This represents a ${formatNumber(Math.abs(profitResult.roi))}% loss on investment.</p>
                    `;
                }
            } else {
                explanationContainer.innerHTML = `
                    <div class="text-yellow-500 font-bold">The sandwich attack would fail.</div>
                    <p>The attack would not succeed because:</p>
                    <ul class="list-disc pl-5">
                        <li>The victim's transaction would fail due to the price impact (${formatNumber(victimResult.priceImpact)}%) exceeding their slippage tolerance (${formatNumber(victimResult.slippageTolerance * 100)}%)</li>
                        <li>Since the victim's transaction fails, the pool state doesn't change, making the back-run unprofitable</li>
                        <li>The attacker would lose their gas costs of ${formatNumber(profitResult.frontRunGasCost)} ETH for the failed front-run</li>
                    </ul>
                `;
            }
            
            explanationContainer.classList.remove('hidden');
            log('Explanation updated');
        }

        // Update victim impact section
        function updateVictimImpact(victimResult) {
            log('Updating victim impact section');
            
            document.getElementById('expectedOutput').textContent = `${formatNumber(victimResult.expectedOutput)} USDC`;
            document.getElementById('actualOutput').textContent = `${formatNumber(victimResult.actualOutput)} USDC`;
            document.getElementById('priceImpact').textContent = `${formatNumber(victimResult.priceImpact)}%`;
            document.getElementById('slippageDisplay').textContent = `${formatNumber(victimResult.slippageTolerance * 100)}%`;
            
            if (victimResult.transactionSucceeds) {
                document.getElementById('transactionStatus').textContent = 'Successful';
                document.getElementById('transactionStatus').className = 'font-medium text-green-600';
            } else {
                document.getElementById('transactionStatus').textContent = 'Failed (Impact > Tolerance)';
                document.getElementById('transactionStatus').className = 'font-medium text-red-600';
            }
            
            log('Victim impact section updated');
        }

        // Update attacker profit section
        function updateAttackerProfit(frontRunResult, backRunResult, profitResult) {
            log('Updating attacker profit section');
            
            document.getElementById('frontRunCost').textContent = `${formatNumber(frontRunResult.ethInput)} ETH`;
            document.getElementById('backRunReturn').textContent = `${formatNumber(backRunResult.ethOutput)} ETH`;
            document.getElementById('totalGasCost').textContent = `${formatNumber(profitResult.totalGasCost)} ETH`;
            document.getElementById('netProfit').textContent = `${formatNumber(profitResult.netProfit)} ETH`;
            document.getElementById('roi').textContent = `${formatNumber(profitResult.roi)}%`;
            
            if (profitResult.isProfitable) {
                document.getElementById('isProfitable').textContent = 'Yes';
                document.getElementById('isProfitable').className = 'font-medium text-green-600';
            } else {
                document.getElementById('isProfitable').textContent = 'No';
                document.getElementById('isProfitable').className = 'font-medium text-red-600';
            }
            
            log('Attacker profit section updated');
        }

        // Update transaction details
        function updateTransactionDetails(frontRunResult, victimResult, backRunResult) {
            log('Updating transaction details');
            
            // Front-run details
            document.getElementById('frontRunEthInput').textContent = `${formatNumber(frontRunResult.ethInput)} ETH`;
            document.getElementById('frontRunFee').textContent = `${formatNumber(frontRunResult.fee)} ETH`;
            document.getElementById('frontRunEthAfterFee').textContent = `${formatNumber(frontRunResult.ethAfterFee)} ETH`;
            document.getElementById('frontRunUsdcOutput').textContent = `${formatNumber(frontRunResult.usdcOutput)} USDC`;
            document.getElementById('frontRunCalculation').textContent = `${formatNumber(frontRunResult.usdcOutput)} = ${formatNumber(frontRunResult.oldK / frontRunResult.newEthReserve)} (using constant product formula)`;
            document.getElementById('frontRunNewPrice').textContent = `${formatNumber(frontRunResult.newUsdcReserve / frontRunResult.newEthReserve)} USDC/ETH`;
            
            // Victim details
            document.getElementById('victimEthInput').textContent = `${formatNumber(victimResult.ethInput)} ETH`;
            document.getElementById('victimFee').textContent = `${formatNumber(victimResult.fee)} ETH`;
            document.getElementById('victimEthAfterFee').textContent = `${formatNumber(victimResult.ethAfterFee)} ETH`;
            document.getElementById('victimExpectedOutput').textContent = `${formatNumber(victimResult.expectedOutput)} USDC`;
            document.getElementById('victimActualOutput').textContent = `${formatNumber(victimResult.actualOutput)} USDC`;
            document.getElementById('victimDifference').textContent = `${formatNumber(victimResult.difference)} USDC`;
            document.getElementById('victimSlippageTolerance').textContent = `${formatNumber(victimResult.slippageTolerance * 100)}%`;
            
            if (victimResult.transactionSucceeds) {
                document.getElementById('victimTransactionStatus').textContent = 'Successful';
                document.getElementById('victimTransactionStatus').className = 'font-medium text-green-600';
            } else {
                document.getElementById('victimTransactionStatus').textContent = 'Failed (Impact > Tolerance)';
                document.getElementById('victimTransactionStatus').className = 'font-medium text-red-600';
            }
            
            // Back-run details
            document.getElementById('backRunUsdcInput').textContent = `${formatNumber(backRunResult.usdcInput)} USDC`;
            document.getElementById('backRunFee').textContent = `${formatNumber(backRunResult.fee)} USDC`;
            document.getElementById('backRunUsdcAfterFee').textContent = `${formatNumber(backRunResult.usdcAfterFee)} USDC`;
            document.getElementById('backRunEthOutput').textContent = `${formatNumber(backRunResult.ethOutput)} ETH`;
            document.getElementById('backRunCalculation').textContent = `${formatNumber(backRunResult.ethOutput)} = ${formatNumber(backRunResult.oldK / backRunResult.newUsdcReserve)} (using constant product formula)`;
            document.getElementById('backRunFinalPrice').textContent = `${formatNumber(backRunResult.newUsdcReserve / backRunResult.newEthReserve)} USDC/ETH`;
            
            log('Transaction details updated');
        }

        // Simulates the sandwich attack
        function simulateAttack() {
            log('Starting sandwich attack simulation');
            
            try {
                // Clear any previous debug information
                document.getElementById('debugLog').textContent = '';
                
                // Get parameters from UI
                const params = getParameters();
                log(`Parameters: ${JSON.stringify(params)}`);
                
                // Initialize pool state
                const initialEthReserve = params.ethReserve;
                const initialUsdcReserve = params.usdcReserve;
                const initialK = initialEthReserve * initialUsdcReserve;
                
                log(`Initial pool state: ETH=${initialEthReserve}, USDC=${initialUsdcReserve}, k=${initialK}`);
                
                // Stage 1: Front-run
                const frontRunResult = simulateFrontRun(
                    initialEthReserve,
                    initialUsdcReserve,
                    params.frontRunAmount,
                    params.poolFee
                );
                
                // Stage 2: Victim trade
                const victimResult = simulateVictimTrade(
                    frontRunResult.newEthReserve,
                    frontRunResult.newUsdcReserve,
                    params.tradeAmount,
                    params.poolFee,
                    params.slippageTolerance,
                    initialEthReserve,
                    initialUsdcReserve
                );
                
                // Stage 3: Back-run (if victim transaction succeeds)
                let backRunResult;
                if (victimResult.transactionSucceeds) {
                    // Use the front-run USDC output for the back-run
                    backRunResult = simulateBackRun(
                        victimResult.newEthReserve,
                        victimResult.newUsdcReserve,
                        frontRunResult.usdcOutput,
                        params.poolFee
                    );
                } else {
                    // If victim transaction fails, the back-run would use the original pool state
                    backRunResult = simulateBackRun(
                        frontRunResult.newEthReserve,
                        frontRunResult.newUsdcReserve,
                        frontRunResult.usdcOutput,
                        params.poolFee
                    );
                }
                
                // Calculate profit
                const profitResult = calculateProfit(
                    params.frontRunAmount,
                    backRunResult.ethOutput,
                    params.gasPrice
                );
                
                // Prepare pool state data for visualization
                const stages = [
                    {
                        name: 'Initial',
                        ethReserve: initialEthReserve,
                        usdcReserve: initialUsdcReserve,
                        k: initialK
                    },
                    {
                        name: 'After Front-run',
                        ethReserve: frontRunResult.newEthReserve,
                        usdcReserve: frontRunResult.newUsdcReserve,
                        k: frontRunResult.newK
                    },
                    {
                        name: 'After Victim',
                        ethReserve: victimResult.newEthReserve,
                        usdcReserve: victimResult.newUsdcReserve,
                        k: victimResult.newK
                    },
                    {
                        name: 'After Back-run',
                        ethReserve: backRunResult.newEthReserve,
                        usdcReserve: backRunResult.newUsdcReserve,
                        k: backRunResult.newK
                    }
                ];
                
                log(`Final profit calculation: ${JSON.stringify(profitResult)}`);
                log(`Stages for visualization: ${JSON.stringify(stages)}`);
                
                // Update UI with results
                updatePoolStateTable(stages);
                updatePriceImpactChart(stages);
                updateLiquidityDepthChart(stages, victimResult);
                updateAttackStatus(victimResult, profitResult);
                updateVictimImpact(victimResult);
                updateAttackerProfit(frontRunResult, backRunResult, profitResult);
                updateTransactionDetails(frontRunResult, victimResult, backRunResult);
                updateExplanation(victimResult, profitResult);
                
                log('Simulation completed successfully');
                return true;
            } catch (error) {
                console.error('Error in simulation:', error);
                log(`ERROR: ${error.message}\n${error.stack}`);
                alert('An error occurred during simulation. Check the debug output for details.');
                return false;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            log('Application initializing');
            
            // Update all value displays
            updateValueDisplays();
            
            // Initialize charts
            initializeCharts();
            
            // Set up input event listeners
            const inputs = document.querySelectorAll('input[type="range"]');
            inputs.forEach(input => {
                input.addEventListener('input', updateValueDisplays);
            });
            
            // Set up simulate button
            document.getElementById('simulateButton').addEventListener('click', function() {
                log('Simulate button clicked');
                simulateAttack();
            });
            
            // Set up toggle explanations
            document.getElementById('toggleExplanation').addEventListener('click', function() {
                const explanationElement = document.getElementById('attackExplanation');
                explanationElement.classList.toggle('hidden');
            });
            
            // Set up toggle details
            const toggleButtons = document.querySelectorAll('.toggle-details');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    content.classList.toggle('hidden');
                    const icon = this.querySelector('svg');
                    icon.classList.toggle('transform');
                    icon.classList.toggle('rotate-180');
                });
            });
            
            log('Application initialized successfully');
            
            // Run initial simulation
            simulateAttack();
        });
    </script>
</body>
</html>
